---
layout: post
title:  "LBS 技术专题"
date:   2016-10-15 10:30:00
categories: 技术工具
tags: 高德 gps geohash base64 gps 北斗
author : 鹤啸九天
excerpt: LBS 技术相关知识
mathjax: true
permalink: /lbs
---

* content
{:toc}

# LBS 技术

汇总 LBS 相关技术


## LBS 

移动互联网如火如荼的今天，各种 `LBS`（Location Based Service，基于地理位置服务）应用遍地开花，其核心要素
- 利用**定位技术**获取当前移动设备（手机）所在的位置
- 然后通过移动互联网获取与当前位置相关的资源和信息

典型的 LBS 应用比如高德地图定位当前位置和附近的建筑、微信查找附近的人、陌陌等陌生人社交应用、滴滴打车查询附近的车、大众点评查找附近的餐馆等等，
- 通过 Geo 可以轻松搞定在海量数据中查找附近 XXX 的功能。

## 地理坐标


### 时空挖掘

【2022-7-13】高德用户常驻点挖掘，拿用户过去一个月的定位点数据聚类，大大超过阿里odps单机800m限制，于是开始思考如何精简数据，方法：
- ① 根据时间信息计算定位点瞬时速度，加速度，剔除运动点，漂移点，过滤了大概2/3
- ② geohash，将地理坐标投射到直线上，降低数据量
  - [geometry](https://halfrost.com/go_spatial_search/) 比geohash 好？
  - [geohash](https://www.cnblogs.com/tgzhu/articles/6204173.html)
- ③ 改进密度聚类算法dbscan，球面距离计算公式部分改成根据经纬度明式距离直接排除噪声点…最终在odps跑通了…另外，调研过路径匹配的方案，微软有篇文章

效果展示 [demo](wqw/demo/points_cluster.html)
- 定位点处理: geohash聚合
  - 3个月定位数据太多，超过Hadoop节点 800m 限制
  - geohash 聚合定位点
- 运动状态计算： 按时间排序，计算速度，区分状态
  - 静态点： 用于常驻点挖掘，占比 1/3
  - 动态点： 用于交通工具挖掘，占比 2/3
- DBSCAN 聚类得到常驻点
  - 去掉噪声点
  - 簇计算，质心
  - GEO获取质心poi
- 预测家、公司
  - 家：一般是夜间、周末
  - 公司：白天，通勤频繁、规律

【2023-8-10】[基于Python实现个人手机定位分析](https://zhuanlan.zhihu.com/p/624916375), TransBigData是一个为交通时空大数据处理、分析和可视化而开发的Python包

交通时空大数据并不局限于交通工具产生的数据，日常生活中也会产生大量的数据。
- 手机记录了到访过的地点；使用城市公交IC卡、共享单车等服务时，服务供应商可以知道这些出行需求的时间和地点等等

TransBigData 一个为交通时空大数据处理、分析和可视化而开发的Python包。
- TransBigData 为处理常见的交通时空大数据（如出租车GPS数据、共享单车数据和公交车GPS数据等）提供了快速而简洁的方法。

TransBigData主要提供以下方法：
- (1) 数据**预处理**：对数据集提供快速计算数据量、时间段、采样间隔等基本信息的方法，也针对多种数据噪声提供了相应的清洗方法。
- (2) 数据**栅格化**：提供在研究区域内生成、匹配多种类型的地理栅格快学Python（矩形、三角形、六边形及geohash栅格）的方法体系，能够以向量化的方式快速算法将空间点数据映射到地理栅格上。
- (3) 数据**可视化**：基于可视化包keplergl，用简单的代码即可在Jupyter Notebook上交互式地可视化展示数据。
- (4) **轨迹处理**：从轨迹数据GPS点生成轨迹线型，轨迹点增密、稀疏化等。
- (5) 地图**底图、坐标转换**与计算：加载显示地图底图与各类特殊坐标系之间的坐标转换。
- (6) 特定处理方法：针对各类特定数据提供相应处理方法，如从出租车GPS数据中提取订单起讫点，从手机信令数据中识别居住地与工作地，从地铁网络GIS数据构建网络拓扑结构并计算最短路径等。

手机信令数据读取

手机信令数据是指手机与通信基站之间交换的信息，包括位置、通信时长、通信频次等数据。这些数据可以用于分析用户的出行行为、生活习惯等，也可以用于城市交通管理、商业营销等领域。
- ![](https://pic3.zhimg.com/80/v2-df544cc9597a84df47b8c11301b3837a_1440w.webp)

识别**出行**和**停留**
- 在处理手机数据时，识别出行和停留是很重要的一步。基于手机识别出行和活动可以进一步进行路径分析、出行模式分析、人群分析等工作。
- 活动：手机数据通过连续地追踪个体的出行轨迹，可以构建出个体的出行链信息，一般来说，如果一个手机用户在某个位置停留了超过30分钟，我们可以认为用户在这里发生了活动。
- 出行：用户产生的连续两个活动如果产生的地理位置不同，则可以认为用户发生了出行行为。出行的起点为连续两个活动中前一个活动的地理位置，出行的开始时间为前一个活动结束的时间，出行的终点则为后一个活动的地理位置，出行的结束时间则为后一个活动开始的时间。简而言之，用户在活动点与活动点之间的移动，视为用户的出行。

活动与出行识别思路
- 使用TransBigData提供的手机信令数据处理方法，可以先将数据对应至栅格，将同一个栅格内的数据视为在同一个位置，以避免数据定位误差导致同一位置被识别为多个。然后，可以使用tbd.mobile_stay_move函数从手机数据中识别出行和停留:

识别居住地与工作地
- 通过移动通信数据识别出用户的职住信息是研究的基础工作之一。TransBigData中，以停留活动点为依据，用tbd.mobile_identify_home方法可以识别居住地，用tbd.mobile_identify_work则可以识别工作地。具体规则为：

居住地识别规则为**夜晚时段停留最长**地点
- 工作地识别规则为工作日白天时段停留最长地点（每日平均时长大于minhour）。

绘制活动图
- 为了加深对手机用户的具体活动情况的理解，我们可以用TransBigData提供的tbd.mobile_plot_activity方法将用户的每日活动情况绘制出来观察
- ![](https://pic4.zhimg.com/80/v2-357766d9c2cf2cf3c7b3b75cacac6a2b_1440w.webp)
- 一个手机用户在观测时间段内每一天的活动情况，横坐标为日期，纵坐标为时间，同一个位置的活动则以同样的颜色显示。从活动图中我们可以很清晰地看到这个用户每一个活动的开始与结束时间。

### GeoHash 


【2023-8-9】[GeoHash 技术原理及应用实战](https://zhuanlan.zhihu.com/p/645078866)

场景
- 打开手机中的地图 app，检索附近1 公里范围内的餐馆，挑选合适的用餐地点

问题
- 如何对指定范围内的餐馆信息进行精确推送和展示
- ![](https://pic2.zhimg.com/80/v2-79b243c3135441d8f67405be3f5a806d_1440w.webp)

解法
- 暴力：遍历所有 经纬度坐标，选最近（不考虑3D城市重庆）

[geohash在线体验](geohash.org) 可以通过哈希值查询其对应的地理位置
- ![](https://ask.qcloudimg.com/http-save/yehe-2413530/n1e9izd7yw.jpeg)

#### 暴力解

简单粗暴的实现方式：
-   把地球上所有餐馆的 (lng,lat) 坐标都维护在一个 list 里
-   获取到小徐先生所在的北京人家的坐标 (lng0,lat0)
-   遍历 list 中所有餐馆的 (lng,lat) 坐标，求出和 (lng0,lat0) 的相对距离，如果大于指定距离就过滤，小于等于指定距离就保留
-   最终被保留在 list 中的餐馆集合就是我们所求的目标
- ![](https://pic4.zhimg.com/80/v2-dcbf193590cb60cd5ede62c0a720221b_1440w.webp)

分析
- 全量餐馆数据规模何其庞大，每次执行范围检索时都要全量遍历计算，工作量足以击垮任何一个服务集群.

#### 索引法

优化思路: 以空间换取时间. 

核心挑战: 如何合理设计用于存储位置信息的空间结构.

常规思路: 
- 利用**索引**提高检索效率
- 本场景中，每个位置是由二维的 (lng,lat) 坐标组成的，这要如何设计成索引呢？

geohash 把这种**二维经纬度坐标**转换成带**前缀索引**性质的**一维坐标**，这个特殊一维坐标称为"geohash 字符串". 

geohash 技术实现很大程度上保证两个 geohash 字符串<span style='color:blue'>公共前缀长度越长，两个区域距离就越接近，并且相对距离范围是可以通过公共前缀的长度估算出具体量级的</span>.
- 该性质只能做到 “**一定程度**上保证”
- 一些边界 case 中可能会出现两个位置本身距离很接近，但是 geohash 字符串的前缀却又差别很大的情况. 

将经纬度坐标(lng,lat) 转为一维 geohash 字符串的示例：

<table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><td>索引 index</td><td>点 point</td><td>经度 lng</td><td>纬度 lat</td></tr><tr><td>YJXY433V</td><td>A</td><td>101</td><td>77</td></tr><tr><td>Y8M76SJ6</td><td>B</td><td>120</td><td>47</td></tr><tr><td>K6BE10DN</td><td>C</td><td>12</td><td>-29</td></tr><tr><td>PBQE6KPD</td><td>D</td><td>178</td><td>-88</td></tr></tbody></table>


#### GeoHash 原理


将**球形**表面“展开”成了一张**矩形平面**，每个位置对应的(lnt,lat) 坐标都可以很方便的在矩形平面上进行定位.
- 沿着经度 -180/180° 的交接位置 “咔嚓”一刀将圆柱体的侧面纵向剪开，将其展开成一个矩形平面图
- 地球在纵向上由 -90°~90° 的纬度范围组成,在横向上由 -180°~180° 的经度范围组成. 因此我们把球面投影成一个矩形平面后，矩形的宽、高刻度就分别对应着经度和纬度，宽度方向上自左向右以 -180°为起点，180°为终点，每个刻度的单位为 1° 经度；高度自底向上以 -90°为起点，90°为终点，每个刻度单位为 1° 纬度.

|示意图|球面|平面|
|---|---|---|
||![](https://pic3.zhimg.com/80/v2-2a47c3c2974119aca084bc4d42043e6e_1440w.webp)|![](https://pic1.zhimg.com/80/v2-4cfd5b8992d3c39046d3faa80bd09064_1440w.webp)|

变换过程
- 沿着**经度**（矩形宽度）的方向进行递归二分，将一个具体经度拆解成一个由二进制数字组成的字符串.
  - 第一轮：经度范围为 -180°~180°，可以拆分成 -180°~0° 以及 0°~180° 两部分，如果经度从属于前者，则令首个 bit 位取 0，否则令首个 bit 位取 1；
  - 第二轮：-180°~0° 可以拆分为 -180°~-90° 和 -90°~0°，如果经度从属于前者，则令第二个 bit 位取 0，否则令第二个 bit 位取 1；0°~180° 可以拆分为 0°~90° 和 90°~180°，前者令第二个 bit 位取 0，后者令第二个 bit 位取 1
  - 第 3 ~ N 轮：重复上述步骤的思路，最终递归二分，将经度表示成一个由二进制数字组成的字符串
- 同样的流程可以应用在**纬度**（矩形高度）的递归二分当中，最终每个具体的纬度也可以被拆分成一个由二进制数字组成的字符串.
- 将沿经度方向的切分和沿纬度方向的切分**合并**在一起，于是整个矩形平面会被切割成网状，形成一个个小的矩形块.

每个矩形块经度区间，会对应有一个经度二进制字符串；同时根据纬度区间，也会有一个纬度二进制字符串. 化二维为一维的关键就是按照经度字符串+纬度字符串依次交错排列的形式，将其组织在一起，最终形成一个一维字符串.
- 这个一维字符串的位数越多，意味着对应的矩形块就越小；同时拥有相同前缀的小矩形块必然从属在同一个大矩形块的范围之内，比如下图左上方的 4 个小矩形：0101、0111、0100、0111 都拥有着公共前缀 "01"，因此，他们都从属于由 "01"表示的这个大矩形块当中.

一维字符串具有前缀索引的性质，他能够保证两个字符串前缀匹配位数越长，两个矩形块的相对位置就越靠近。
- ![示意图](https://pic2.zhimg.com/80/v2-08738864cf35255759b650304b80f395_1440w.webp)

|经度|纬度|合并|
|---|---|---|
|![](https://pic1.zhimg.com/80/v2-f49beb4f7d33b5063cffc7a54a3fef08_1440w.webp)|![](https://pic3.zhimg.com/80/v2-083900d3cd3f593ce896ca0685044b0e_1440w.webp)|![](https://pic4.zhimg.com/80/v2-1316f134d93b33d21d4a034e546d129b_1440w.webp)|


geohash 编码格式
- 为了进一步节省空间，geohash 采用 Base32 编码替代了原始的二进制字符串.
- Base32 编码主要是以 10 个数字字符 ‘0’-‘9’ 加上 26 个英文字母 ‘A’-‘Z’ 组成，并在其中把几个容易产生混淆的字符 'I' 'L' 'O' 以及字母 'A' 去掉了，最终总计保留下来 32 个字符

遵循 geohash 思路，将一个二进制字符串转为 Base32 编码形式的示例：
- ![](https://pic4.zhimg.com/80/v2-1ad764cbfae3103a3ca165bfb336c8ff_1440w.webp)

将地球表面上每个递归二分得到的小矩形块表示成 geohash 字符串的形式. 下图是通过 6 位 geohash 字符串，对北京西二旗附近区域进行切分表示的示例：
- ![](https://pic1.zhimg.com/80/v2-d9ffc0645f3ec66cdde09f2739922b28_1440w.webp)

**长度决定精度**

在 geohash 字符串中，字符串的长度决定了矩形块的大小，进一步决定了距离的精度. 在对经纬度进行递归二分时，每多一轮二分，矩形一个方向上的边长就会减半，因此矩形区域就越小，对应的精度就越高. 下面是 geohash 字符串长度和距离精度的映射关系：

<table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><td>geohash字符串长度（base32）</td><td>lat bits纬度二进制位数</td><td>lng bits经度二进制位数</td><td>lat error纬度方向长度（°）</td><td>lng error经度方向长度（°）</td><td>km error矩形边长（km）</td></tr><tr><td>1</td><td>2</td><td>3</td><td>±23</td><td>±23</td><td>±2500</td></tr><tr><td>2</td><td>5</td><td>5</td><td>±2.8</td><td>±5.6</td><td>±630</td></tr><tr><td>3</td><td>7</td><td>8</td><td>±0.70</td><td>±0.70</td><td>±78</td></tr><tr><td>4</td><td>10</td><td>10</td><td>±0.087</td><td>±0.18</td><td>±20</td></tr><tr><td>5</td><td>12</td><td>13</td><td>±0.022</td><td>±0.022</td><td>±2.4</td></tr><tr><td>6</td><td>15</td><td>15</td><td>±0.0027</td><td>±0.0055</td><td>±0.61</td></tr><tr><td>7</td><td>17</td><td>18</td><td>±0.00068</td><td>±0.00068</td><td>±0.076</td></tr><tr><td>8</td><td>20</td><td>20</td><td>±0.000085</td><td>±0.00017</td><td>±0.019</td></tr></tbody></table>

geohash 实现步骤
- 取得经纬度
  - 如经纬度信息：(116.311126,40.085003)
- 经度递归二分
  - 预期生成的 geohash 字符串长度为 6 位，则对应的经度和纬度二进制字符串的 bit 位长度需要为 15 位. 最终取得的 geohash 字符串所对应的矩形块边长范围约为 610 m.
  - 最终，递归二分得到经度方向上的二进制字符串为 110100101011010，长度为 15 位.
- 纬度递归二分： 对经度 40.085003 进行二分，首轮从 -90°~90°的范围开始
  - 最终，递归二分得到纬度方向上的二进制字符串为 101110010000001，长度为 15 位.
- 经纬度字符串拼接
  - 结合经度字符串 110100101011010 和纬度字符串 101110010000001，我们遵循先经度后纬度的顺序，逐一交错排列，最终得到的一维字符串为 11100 11101 00100 11000 10100 01001.
  - ![](https://pic3.zhimg.com/80/v2-57d0f241933ee63175c03c431a29f50e_1440w.webp)
- Base32编码
  - 一维二进制字符串 11100 11101 00100 11000 10100 01001 的基础上，我们从左往后，以每 5 个 bit 成一组，转为 Base32 编码的表达形式，最终得到的编码结果为 WX4SN9
  - ![](https://pic1.zhimg.com/80/v2-4a50c91bc1e82ce5ec4b5589af026ec4_1440w.webp)


#### geohash 具体实现


geohash 
- 转换
  - ![](https://pic2.zhimg.com/80/v2-66fb7497cf630241cbcb4dcbd011afb5_1440w.webp)
- 查询
  - ![](https://pic3.zhimg.com/80/v2-c662d8aa82cb45762bc6453735b47ef6_1440w.webp)
- 添加
  - ![](https://pic1.zhimg.com/80/v2-4571fdba68cf186472a82d0b285c8250_1440w.webp)
- 前缀查询
  - ![](https://pic4.zhimg.com/80/v2-ca4712cf466ac9e65b29e78738bfa317_1440w.webp)
- 删除
  - ![](https://pic1.zhimg.com/80/v2-487cf51a237a793325d63a202e085f9c_1440w.webp)
- 范围查询
  - ![](https://pic2.zhimg.com/80/v2-5301cd681bfe8308816ea78c245a0ead_1440w.webp)

go 源码见[原文](https://zhuanlan.zhihu.com/p/645078866)

geohash 与 trie
- 首先要对 geohash 字符串的存储数据结构进行选型.

geohash 服务模块需要对外提供的几个 API 整理如下：
- Hash：将用户输入的经纬度 lng、lat 转为 geohash 字符串
- Get：通过传入的 geohash 字符串，获取到对应于矩形区域块的 GEOEntry 实例
- Add：通过用户传入的经纬度 lng、lat，构造出 point 实例并添加到对应的矩形区域中
- ListByPrefix：通过用户输入的 geohash 字符串，获取到对应矩形区域块内所有子矩形区域块的 GEOEntry 实例（包含本身）
- Rem：通过用户输入的 geohash 字符串，删除对应矩形区域块的 GEOEntry
- ListByRadiusM：通过用户输入的中心点 lng、lat，以及对应的距离范围 radius，返回范围内所有的点集合

#### geohash 问题


(1) **边缘性局限**问题

- 将矩形平面通过递归二分的方式，切分成一个个小的矩形块，而每个矩形块有着自己与毗邻矩形块的交界区域，倘若有两个点分别从属于两个毗邻矩形块，但是又同时靠近于它们的交界线，此时就会出现两个点实际距离接近，但前缀匹配长度不足的情况.
- ![](https://pic1.zhimg.com/80/v2-b2aa459166b4d4fd4fa5d5c65d087f50_1440w.webp)
- A、B 两个点同属于一个矩形块中，有着更长的公共前缀；C、D、E 三个点和 A 不从属于同一个矩形块，与A 的 geohash 字符串前缀匹配长度相较于 B 而言要更短，然而其本身和 A 的相对距离却是要更接近的.

为了避免在近距离位置检索过程中出现目标的遗漏，通常会在通过 geohash 锁定一个小的矩形块后，以其作为中心，将周围 8 个矩形块范围内的点也同时检索出来，再根据实际的相对距离进行过滤.

(2) 最短距离问题

找到距离点 A 最近的目标点. 以 A 所在矩形为中心，基于“回”字形的拓扑结构向外逐层向外拓宽，此时我们是无法保证靠内侧的“回”字形层次中出现的目标点一定比外层的点距离点 A 更近.

比如以下图为例，点 F 相比于点 G ，在层次上与点 A 更加靠近，但是实际上与点 A 的相对距离要长于点 G.
- ![](https://pic4.zhimg.com/80/v2-e4b6e8e1a16a14887848fb324f262ef3_1440w.webp)

为了解决这个问题，遇到首个目标点后，额外向外扩展几圈，直到保证扩展范围边界与点 A 的相对距离已经长于首个目标点后才能停止扩展流程. 接下来需要取出扩展范围内所有的点，分别计算出与点 A 的相对距离，最终取出距离最小的那个点，即为我们所求的结果.

(3) 范围检索思路

应用 geohash 技术的一类场景是：
> 给定一个指定位置作为中心点，想要检索出指定半径范围内的所有点集合.

解决思路
- 首先求出中点所在的矩形块及其对应的 geohash 字符串
- 然后基于回字形向外逐层拓宽，直到能保证拓展范围一定能完全包含以中心点为圆心、指定距离为半径的圆后，求出拓展范围内所有的点（此时可能有多余的结果），再通过其与中心点的相对距离进行过滤，保留满足条件的目标点集合.
  - ![](https://pic3.zhimg.com/80/v2-a2367bce85a3042881be976781a9e612_1440w.webp)


### geo

地理位置查询功能 geo,全称 geospatial 

#### GEO 场景

通过 Geo 可以轻松搞定在海量数据中查找附近 XXX 的功能。
- 地理围栏：通过设置地理位置的经纬度信息，可以将用户或者车辆等实体绑定在地理围栏内，当实体进出围栏时，可以触发相应的事件。
- 附近的人：在类似于约会、社交、旅游等场景下，可以通过Redis GEO快速查询周围的人员或景点。
- 配送服务：通过获取配送地址的经纬度信息，可以找到距离最近的配送员或仓库，并对订单进行分配。
- 地址查找：在地图应用中，可以通过Redis GEO快速查询某个地址周围的商家或服务设施。
- 动态信息：在滴滴、Uber等打车应用中，可以实时更新车辆的位置信息，以提供更加准确的车辆推荐和路线规划服务


#### Redis GEO


Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作，该功能在 Redis 3.2 版本新增。

Redis GEO 操作方法有：
- geoadd：添加地理位置的坐标。
- geopos：获取地理位置的坐标。
- geodist：计算两个位置之间的距离。
- georadius：根据用户给定的经纬度坐标来获取指定范围内的地理位置集合。
- georadiusbymember：根据储存在位置集合里面的某个地点获取指定范围内的地理位置集合。
- geohash：返回一个或多个位置对象的 geohash 值。


```sh
# 添加位置信息
本机:0>geoadd user:location 121.48941  31.40527 'shagnhai'
"1"
# 添加多个位置信息
本机:0>geoadd user:location 121.47941 31.41527 'shanghai1'  121.47941 31.43527 'shagnhai2'  121.47941 31.40527 'shagnhai3'
"3"

# 计算距离，单位有m km ft(英尺） mi(英里）
# 计算两点间的距离，单位m
本机:0>geodist user:location shanghai shanghai1 m
"1462.1834"
# 千米：km
本机:0>geodist user:location shanghai shanghai1 km
"1.4622"

# geohash 返回一个或多个位置元素的geohash，保存Redis中是用geohash位置52点整数编码
# geohash 将二维经纬度转换成字符串，每个字符串代表一个矩形区域，该矩形区域内的经纬度点都共享一个相同的geohash字符串。
本机:0>geohash user:location shanghai shanghai1
1) "wtw6st1uuq0"
2) "wtw6sqfx5q0"

# geopos 从key里返回指定成员的位置信息
本机:0>geopos user:location shanghai shanghai1
1) 1) "121.48941010236740112"
   2) "31.40526993848380499"

2) 1) "121.47941082715988159"
   2) "31.41526941345740198"

# georadius:给定经纬度为中心，返回键包含的位置元素中，与中心的距离不超过给定最大距离的所有位置元素
# 范围单位：m km mi ft
# withcoord:将位置元素的经纬度一并返回
本机:0>georadius user:location 121.48941 31.40527 3000 m withcoord
1) 1) "shagnhai3"
   2) 1) "121.47941082715988159"
      2) "31.40526993848380499"

2) 1) "shanghai1"
   2) 1) "121.47941082715988159"
      2) "31.41526941345740198"

3) 1) "shanghai"
   2) 1) "121.48941010236740112"
      2) "31.40526993848380499"
# withdist:返回位置元素的同时，将位置元素与中心点间的距离一并返回
本机:0>georadius user:location 121.48941 31.40527 3000 m withdist
1) 1) "shagnhai3"
   2) "949.2411"

2) 1) "shanghai1"
   2) "1462.1719"

3) 1) "shanghai"
   2) "0.0119"

# asc:根据中心位置，按照从近到远的方式返回位置元素
本机:0>georadius user:location 121.48941 31.40527 3000 m withdist asc
1) 1) "shanghai"
   2) "0.0119"

2) 1) "shagnhai3"
   2) "949.2411"

3) 1) "shanghai1"
   2) "1462.1719"

# desc: 根据中心位置，按照从远到近的方式返回位置元素
本机:0>georadius user:location 121.48941 31.40527 3000 m withdist desc
1) 1) "shanghai1"
   2) "1462.1719"

2) 1) "shagnhai3"
   2) "949.2411"

3) 1) "shanghai"
   2) "0.0119"

# count：获取指定数量的元素
本机:0>georadius user:location 121.48941 31.40527 3000 m withdist desc count 2
1) 1) "shanghai1"
   2) "1462.1719"
2) 1) "shagnhai3"
   2) "949.2411"

# georadiusbymember:和georadius命令类似，都可以找出指定位置范围内的元素，但是georadiusbymember的中心点是由给定位置元素决定的，而不像georadius使用经纬度决定中心点
本机:0>georadiusbymember user:location shanghai 3 km 
1) "shagnhai3"
2) "shanghai1"
3) "shanghai"

```


## 定位

### 手机定位方式

手机常用的定位方式有：
- 卫星定位(GPS，北斗，伽利略，Glonass)；
- 移动基站定位；
- WiFi辅助定位；
- AGPS定位。

注
- IPhone系统比较封闭，对用户隐私保护较好，微信对用户隐私保护也很好，不容易获取

参考
- [常见手机定位方式](https://www.cnblogs.com/syfwhu/p/5084115.html)

### 1. 基站定位

因为处在相同频率范围的信号会相互干扰，为防止相邻基站相互干扰，相邻的基站会选择不同的信道（不同频率范围的信号）与移动设备通信。如上图是一个蜂窝移动基站的示意图，其任意相邻的两个基站都具有不同的通信频段。基站不是孤立存在的，其覆盖区域相互交接，组成一张巨大的移动通信网络（如下图）。

![](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228214055385-1589270682.png)

图4 蜂窝基站

移动设备在插入sim卡开机以后，会主动搜索周围的基站信息，与基站建立联系，而且在可以搜索到信号的区域，手机能搜索到的基站不止一个，只不过远近程度不同，再进行通信时会选取距离最近、信号最强的基站作为通信基站。其余的基站并不是没有用处了，当你的位置发生移动时，不同基站的信号强度会发生变化，如果基站A的信号不如基站B了，手机为了防止突然间中断链接，会先和基站B进行通信，协调好通信方式之后就会从A切换到B。这也就是为什么同样是待机一天，你在火车上比在家里耗电要多的原因，手机需要不停的搜索、连接基站。每次坐火车，我都会把手机调成飞行模式，看看电影、听听歌，依然可以维持很长时间。
- ![移动网络](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228214118464-194485334.png)

如上图所示，在这张巨大移动网络中，根据你所在的小区，所从属的基站就可大致知道你的位置信息，如果再加上一些估计算法，就可以更确切的找出你的位置。

#### 基站定位原理

移动电话测量不同基站的下行导频信号，得到不同基站下行导频的TOA（到达时刻）或 TDOA(到达时间差)，根据该测量结果并结合基站的坐标，一般采用三角公式估计算法，就能够计算出移动电话的位置。实际的位置估计算法需要考虑多基站(3个或3个以上)定位的情况，因此算法要复杂很多。一般而言，移动台测量的基站数目越多，测量精度越高，定位性能改善越明显。

直白的说，距离基站越远，信号越差，根据手机收到的信号强度可以大致估计距离基站的远近，当手机同时搜索到至少三个基站的信号时（现在的网络覆盖这是很轻松的一件事情），大致可以估计出距离基站的远近；基站在移动网络中是唯一确定的，其地理位置也是唯一的，也就可以得到三个基站（三个点）距离手机的距离，根据三点定位原理，只需要以基站为圆心，距离为半径多次画圆即可，这些圆的交点就是手机的位置。网传的微信三点定位原理也是这个样子。
- ![三点定位原理](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228214148073-177650567.png)

由于基站定位时，信号很容易受到干扰，所以先天就决定了它定位的不准确性，精度大约在150米左右，基本无法开车导航。定位条件是必须在有基站信号的位置，手机处于sim卡注册状态（飞行模式下开wifi和拔出sim卡都不行），而且必须收到3个基站的信号，无论是否在室内。但是，定位速度超快，一旦有信号就可以定位，目前主要用途是没有GPS且没有wifi的情况下快速大体了解下你的位置。另外，如果手机里没有基站位置数据包，还需要联网才行。

### 2. WiFi定位

WiFi（也就是Wireless Access Point：AP，或者无线路由器）定位的方法有很多种，例如可以依据测信号强度来判定目标的距离，也可以依据信号角度来检测目标的方向和角度，依据相位，时间和时间差来初步判定目标距离AP的位置等等。

#### WiFi定位原理

-   每一个无线AP（路由器）都有一个全球唯一的MAC地址，并且一般来说无线AP在一段时间内不会移动；
-   设备在开启Wi-Fi的情况下，无线路由器默认都会进行SSID广播（除非用户手动配置关闭该功能），在广播帧包含了该路由器的MAC地址；
-   采集装置可以通过接收周围AP发送的广播信息获取周围AP的MAC信息和信号强度信息，将这些信息上传到服务器，经过服务器的计算，保存为“MAC-经纬度”的映射，当采集的信息足够多时候就在服务器上建立了一张巨大的WiFi信息网络；
-   当一个设备处在这样的网络中时，可以将收集到的这些能够标示AP的数据发送到位置服务器，服务器检索出每一个AP的地理位置，并结合每个信号的强弱程度，计算出设备的地理位置并返回到用户设备，其计算方式和基站定位位置计算方式相似，也是利用三点定位或多点定位技术；
-   位置服务商要不断更新、补充自己的数据库，以保证数据的准确性。当某些WiFi信息不在数据库中时，可以根据附近其他的WiFi位置信息推断出未知WiFi的位置信息，并上传服务器。

![WiFi 定位](https://images2015.cnblogs.com/blog/716683/201512/716683-20151229111557057-1002615358.gif)


#### 数据采集

这些AP位置映射数据怎么采集的呢？其采集方式大致可以分为主动采集和用户提交。

**主动采集**：

谷歌的街景拍摄车还有一个重要的功能就是采集沿途的无线信号并打上通过GPS定位出的坐标回传至服务器，Skyhook公司也是采用这样的方式。

**用户提交**：

Android手机用户在开启“使用无线网络定位”时会提示是否允许使用Google的定位服务，如果允许，用户的位置信息就被谷歌收集到。iPhone则会自动收集WiFi的MAC地址、GPS位置信息、运营商基站编码等，并发送给苹果公司的服务器。

由上面的介绍可知，WiFi定位在AP密集的地方有很好的效果，比如在GPS不能使用的室内，而且具有较快的反映速度，在不连上WiFi的情况下也可以定位，这就是有时候在不开数据服务时百度地图提示打开WiFi功能定位的原因。由于其依赖于WiFi，如果不想让人通过这种方式知道你的位置信息，直接关闭WLAN功能即可。

### 3. AGPS定位 

AGPS（AssistedGPS：辅助全球卫星定位系统）是结合GSM/GPRS与传统卫星定位，利用基地台代送辅助卫星信息，以缩减GPS芯片获取卫星信号的延迟时间，受遮盖的室内也能借基地台讯号弥补，减轻GPS芯片对卫星的依赖度。AGPS利用手机基站的信号，辅以连接远程定位服务器的方式下载卫星星历 (英语：Almanac Data)，再配合传统的GPS卫星接受器，让定位的速度更快。是一种结合网络基站信息和GPS信息对移动台进行定位的技术，既利用全球卫星定位系统GPS，又利用移动基站，解决了GPS覆盖的问题，可以在2代的G、C网络和3G网络中使用。

普通的GPS系统是由GPS卫星和GPS接受器组成，与普通的GPS不同，AGPS在系统中还有一个辅助定位服务器。在AGPS网络中，接收器可通过与辅助服务器的通信而获得定位辅助。由于AGPS接收器与辅助服务器间的任务是互为分工的，所以AGPS往往比普通的GPS系统有速度更快的定位能力、有更高的效率，可以很快捕捉到GPS信号，这样的首次捕获时间将大大减小，一般仅需几秒的时间（单纯GPS接收机首次捕获时间可能要2～3分钟时间），而精度也仅为几米，高于GPS的精度。 利用AGPS接收器不必再下载和解码来自GPS卫星的导航数据，因此可以有更多的时间和处理能力来跟踪GPS信号，这样能降低首次定位时间，增加灵敏度以及具有最大的可用性。

#### AGPS定位基本步骤

-   AGPS手机首先将本身的基站地址信息通过网络传输到定位服务器； 
-   定位服务器根据该手机的大概位置传输与该位置相关的GPS辅助信息（包含GPS的星历和方位俯仰角等）到手机； 
-   该手机的AGPS模块根据辅助信息（以提升GPS信号的第一锁定时间TTFF能力）接收GPS原始信号； 
-   手机在接收到GPS原始信号后解调信号，计算手机到卫星的伪距（伪距为受各种GPS误差影响的距离），并将有关信息通过网络传输到定位服务器； 
-   定位服务器根据传来的GPS伪距信息和来自其他定位设备（如差分GPS基准站等）的辅助信息完成对GPS信息的处理，并估算该手机的位置； 
-   定位服务器将该手机的位置通过网络传输到定位网关或应用平台（如手机上的GPS应用程序）。

![AGPS定位](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228214240526-1332226721.png)

AGPS的优势主要在其定位精度上。在室外等空旷地区，其精度在正常的GPS工作环境下，可达10米左右，堪称目前定位精度最高的一种定位技术。另一优点为：首次捕获GPS信号的时间一般仅需几秒，不像GPS的首次捕获时间可能要2～3分钟。虽然AGPS技术的定位精度很高、首次捕获GPS信号时间短，但是该技术也存在着一些缺点。首先，室内定位的问题目前仍然无法圆满解决。另外，AGPS的定位实现必须通过多次网络传输（最多可达六次单向传输），这对运营商来说是被认为大量的占用了空中资源，对消费者而言将产生不少的流量费用。而且AGPS手机比一般手机在耗电上有一定的额外负担，间接减短了手机的待机时间。除此之外，有时无法取得多个卫星传来的讯号，通常这是因为您的AGPS 话机天线接收器所在环境的限制。在这种情况下，AGPS 功能将不能很好地使用。


### 4. 卫星导航系统

常见的卫星定位系统： `GPS`、`北斗`、`伽利略`和`Glonass`

虽然这些系统提供的服务有些差异，但其背后的定位原理都是相同，现在以应用最广泛的GPS为例来介绍卫星定位。

《日本经济新闻》2020年8月20日报道，美国长期以来一直是全球卫星定位系统的领导者，但现在，中国的北斗卫星导航系统在规模上已经超过美国的GPS。
- [中国北斗与美国GPS差距有多大？核心数据曝光，日媒惊叹](https://zhuanlan.zhihu.com/p/79153773)

全球4大卫星导航系统对比

| 系统 | GPS | 北斗 | GLONASS | Galileo |
|---|---|---|---|---|
| 研制国家 | 美国 | 中国 | 俄罗斯 | 欧盟 |
| 首颗卫星升空时间 | 1985年 | 1989年 | 2000年 | 2011年 |
| 卫星总数 | 43颗 | 38颗 | 24颗 | 30颗 |
| 应用时间 | 1994年 | 2000年北斗一号、2012年北斗二号、2020年北斗三号 | 2016年（早期工作能力) | 2007年（服务俄罗斯)、2009年(服务全球) |
| 竞争优势 | 成熟 | 开放且具备短信通信功能 | 抗干扰能力强 | 精度高 |
| 后期发展 | 预计于2033年部署完成由GPS三代卫星组成的空间星座，届时定位精度可达：水平2.1m、高程3.2m | 预计于2020年完成全球覆盖，届时定位精度最高可达2.5m | 计划于2025年前将其更新为GLONASS-K，系统届时定位精度可达3m | 预计于2019年建成，届时将具备完全工作能力，最高精度可达1m以内 |

GPS仅向地面发送信号，难以锁定接收信号的终端的位置信息，但北斗还有一点优势，它具备收发信号的功能。

美国曾借助GPS在全球定位服务领域先行一步，而中国正一步步夺取美国的地位。可以清晰地看到，在卫星领域中国已开始反超美国。

卫星导航定位行业按照定位精度差别可区分为两大服务群体：
- 一是**高精度GNSS**行业（常规使用的定位误差在**米级**以下），应用在测绘勘探、地理信息、地质灾害监测、精细农林业、国防、时间同步等领域
- 二是**消费类**行业（常规使用的定位误差在1米至**10米**以上），例如手机导航、车载导航等。近年来，随着大数据、物联网特别是无人驾驶等新兴技术的不断进步，用定位精度来区分服务群体的界限已逐渐模糊。例如高精度定位在无人驾驶技术中占据了极为重要的位置，而无人驾驶显然未来的属性为消费类。

北斗将在自动驾驶领域大放异彩，北斗高精度芯片将作为新车的标配，为自动驾驶提供亚米级甚至厘米级定位服务，而相关的北斗高精度服务也将迎来最大的客户需求。


#### GPS

**GPS**（Global Positioning System）即全球定位系统，是由美国建立的一个卫星导航定位系统，利用该系统，用户可以在全球范围内实现全天候、连续、实时的三维导航定位和测速；另外，利用该系统，用户还能够进行高精度的时间传递和高精度的精密定位。

##### GPS系统构成

GPS系统包括三大部分: 
- 空间部分--GPS卫星星座；
- 地面控制部分--地面监控部分；
- 用户设备部分--GPS信号接收机。

GPS系统构成如图：
- ![](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228213715495-546188642.png)


##### GPS工作卫星及其星座

21颗工作卫星和3颗在轨备用卫星组成GPS卫星星座。24颗卫星距地高度为20200km，运行周期为11小时58分(恒星时12小时)，均匀分布在6个轨道平面内,轨道倾角为55度,各个轨道平面之间相距60度，每个轨道平面内各颗卫星之间相差90度。卫星通过天顶时,卫星可见时间为5个小时，在地球表面上任何地点任何时刻，在高度角15度以上，平均可同时观测到6颗卫星，最多可达9颗卫星。示例如图2：
- ![GPS卫星网络](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228213924260-1451331394.png)


为了解算测站的三维坐标，必须观测4颗GPS卫星，称为定位星座。

**地面监控系统**

对于导航定位来说，GPS卫星是一动态已知点。星的位置是依据卫星发射的星历--描述卫星运动及其轨道的参数算得的。每颗GPS卫星所播发的星历，是由地面监控系统提供的。卫星上的各种设备是否正常工作，以及卫星是否一直沿着预定轨道运行，都要由地面设备进行监测和控制。地面监控系统另一个重要作用是保持各颗卫星的时间，求出钟差，然后由地面注入站发给卫星，卫星再由导航电文发给用户设备。

GPS工作卫星的地面监控系统包括一个主控站、三个注入站和五个监测站。主控站的作用是根据各监控站对GPS的观测数据，计算出卫星的星历和卫星钟的改正参数等，并将这些数据通过注入站注入到卫星中去；同时，它还对卫星进行控制，向卫星发布指令，当工作卫星出现故障时，调度备用卫星，替代失效的工作卫星工作；另外，主控站也具有监控站的功能；监控站主要任务是为主控站提供卫星的观测数据；注入站任务是将主控站发来的导航电文注入到相应卫星的存储器。

**GPS信号接收机** 

能够捕获到按一定卫星高度截止角所选择的待测卫星的信号，并跟踪这些卫星的运行，对所接收到的GPS信号进行变换、放大和处理，以便测量出GPS信号从卫星到接收机天线的传播时间，解译出GPS卫星所发送的导航电文，实时地计算出测站的三维位置，甚至三维速度和时间。　　

##### GPS定位原理

GPS导航系统的基本原理是测量出已知位置的卫星到用户接收机之间的距离，然后综合多颗卫星的数据就可知道接收机的具体位置。要达到这一目的，卫星的位置可以根据星载时钟所记录的时间在卫星星历中查出。而用户到卫星的距离则通过纪录卫星信号传播到用户所经历的时间，再将其乘以光速得到(由于大气层电离层的干扰，这一距离并不是用户与卫星之间的真实距离，而是伪距）。

当GPS卫星正常工作时，会不断地用1和0二进制码元组成的伪随机码(简称伪码)发射导航电文。导航电文包括卫星星历、工作状况、时钟改正、电离层时延修正、大气折射修正等信息。GPS导航系统卫星部分的作用就是不断地发射导航电文。然而，由于用户接受机使用的时钟与卫星星载时钟不可能总是同步，所以除了用户的三维坐标x、y、z外,还要引进一个变量 t 即卫星与接收机之间的时间差作为未知数，然后用4个方程将这4个未知数解出来。所以如果想知道接收机所处的位置，至少要能接收到4个卫星的信号。如下图所示： 

![GPS位置计算方法](https://images2015.cnblogs.com/blog/716683/201512/716683-20151228214007214-442935877.png)

从以上四个方程中解出x，y，z和t就可以定时、定位。

GPS定位方式，不需要sim卡，不需要连接网络，只要在户外，基本上随时随地都可以准确定位。其他类型卫星定位方式与GPS差不多，不再讲述。

#### 北斗

##### 哪些手机支持北斗

中科院官方科普平台“科学大院”介绍，北斗信号的获取主要取决于**手机处理器**（SOC）中集成的**定位芯片**，目前大多SOC都能同时支持`GPS`、`北斗`和`GlONASS`：
- 高通骁龙800、600、400系列，其中目前常见的820、821、835高端型号是支持北斗的，中低端的652、650、625、436，甚至更老的一些型号也都是支持。
- 联发科类似，目前常见的P10、P15、P20、X20，之前的X10都支持接收北斗信号。
- 华为海思很早就支持了北斗。从麒麟930开始，集成的Hi1101四合一芯片可以同时接收GPS、北斗和GLonass三种信号。
- 也就是说，除了任性的苹果，采用这些SOC的华为、O&V、小米、一加、魅族、HTC、努比亚等品牌的大部分型号手机都支持北斗定位

##### 如何切换北斗

测试软件试试，比如“GPS状态”、“北斗伴”、“AndroiTS GPS Test Pro”等等，以AndroiTS GPS Test Pro为例：找个户外开阔的地方，打开手机的“位置服务”，然后运行[AndroiTS GPS Test Pro](http://www.danji100.com/app/139506.html)软件，效果如下：
- ![](https://pic3.zhimg.com/80/v2-d66172d2edc6a3d7a6cdd12a8463c682_720w.jpg)
- 1、在手机桌面点击打开“应用市场”。
- 2、点击搜索“AndroiTS GPS Test Pro”软件下载安装到手机。
- 3、点击“设置”。
- 4、点击列表中“定位服务”。
- 5、将右侧滑动按钮开启。
- 6、AndroiTS GPS Test Pro软件，点击最下方第三个图标，就是我国的北斗导航卫星系统。


手机导航，其实是北斗进入比较晚的行业了。现任中国卫星导航系统管理办公室主任、北斗系统新闻发言人冉承其曾给出一组数据：过去5年，我国480万辆营运车辆上线“北斗”，建成全球最大的北斗车联网平台，全国4万余艘渔船安装“北斗”。他以北京为例，已有33500辆出租车、21000辆公交车安装“北斗”，实现“北斗”定位全覆盖；1500辆物流货车及19000名配送员，使用“北斗”终端和手环接入物流云平台，实现实时调度。







# 结束
















