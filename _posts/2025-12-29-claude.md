---
layout: post
title:   Claude 使用笔记
date:   2025-12-29 16:52:00
categories: 大模型
tags: claude skill mcp langchain
excerpt: Claude 使用笔记
mathjax: true
permalink: /claude
---

* content
{:toc}

# Claude 使用笔记



## Claude Code

Claude Code 是 Anthropic 推出的Agent编码工具，支持在终端运行，理解代码库，并通过自然语言命令帮助用户更快的编写代码，功能和Cursor类似。

绝对不止是写代码，而是一款真正意义上的通用 Agent。很多电脑上的很繁琐的工作，都是 CC 一句话的事情。
- 做问答、写作、写网页、写软件，数据分析、甚至拆分工资条。

Claude Code 可直接在终端运行：自动收集并理解项目上下文，再按需遍历整个代码库，无须手动将文件加入上下文。

更令人惊喜的是，Claude Code在处理跨文件编辑方面的能力几乎无人能敌。

资料
- [开源模型质变：Claude Code 超级小白入门指南](https://mp.weixin.qq.com/s/pEPweAhpzZb1ef5oMvaDDA)


### 安装

步骤
- 科学上网环境
- 最新版本的 Node.js ，地址：[download](https://nodejs.org/en/download/)
- WIndows 用户还需要额外安装 Git for Windows，地址：[windows](https://git-scm.com/install/windows)

【2025-8-26】[用神器Claude Code！打造贴身AI秘书团](https://www.bilibili.com/video/BV1zqeMzfEiQ)

视频演示

<iframe src="//player.bilibili.com/player.html?isOutside=true&aid=115059808341051&bvid=BV1zqeMzfEiQ&cid=31819960066&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" weight="600" ></iframe>


#### 国内安装

官方 CC 丧心病狂，封号严重, 国内对 CC 模型支持好的有三个：GLM 4.7，MiniMax M2.1，Kimi K2。
- [智谱开放平台](https://open.bigmodel.cn/) 注册 key [API Keys](https://bigmodel.cn/usercenter/proj-mgmt/apikeys)

【2025-8-30】[Claude Code 接入本地/第三方模型的两条路](https://zhuanlan.zhihu.com/p/1945133468855046287)

目标：
- 纯命令行下，让 Claude Code 不再直连官方，而是走更便宜或本地化的模型（如 LM Studio / Ollama / vLLM / Kimi 等）

Claude Code 支持「LLM Gateway」模式 + 自定义 base_url。

关键环境变量（记住这三个就够）
- ANTHROPIC_BASE_URL：网关或服务的根地址（必须能接收 /v1/messages）。
- ANTHROPIC_AUTH_TOKEN：发给该地址的鉴权令牌（Bearer）。
- ANTHROPIC_MODEL：给 Claude Code 用的“外部模型名”（由网关/服务定义的名字）。

Claude Code 理论上能接到任何把自己“伪装成 Anthropic Messages”的端点（原生支持，或经网关转译支持

Claude Code 启动时：
- 把请求发到官方 Anthropic API；
- 第一时间检查是否登录 / 有 Pro / 有官方 API Key；
- 没付费就到此为止。

绕开的方法： 
- 把“去向”改成自己的地址。设置上面的 3 个变量，别再找官方，而是找指定的网关/服务。

两种落地方式
- ✅ 方式 A：直连“原生兼容 Anthropic /v1/messages”的第三方/网关
- ✅ 方式 B：中转不兼容的后端 → `LiteLLM` 做“协议翻译”（Anthropic ⇄ OpenAI）
  - 用 LiteLLM 代理把“Anthropic 请求”翻译成“OpenAI 请求”，再转给后端



#### Mac 安装

```sh
# MacOS（Homebrew）：
brew install --cask claude-code
# MacOS、Linux、WSL：
curl -fsSL https://claude.ai/install.sh | bash
# npm 安装
# 【2025-12-29】报错
# npm ERR! code UNABLE_TO_GET_ISSUER_CERT_LOCALLY
# npm ERR! unable to get local issuer certificate
# 解决：临时忽略 SSL 验证，通过关闭 SSL 验证来解决此问题，但请注意这可能会降低安全性。
npm config set strict-ssl false
# 安装完成后，建议恢复为 true：
npm config set strict-ssl true

# 设置代理
npm config set proxy http://127.0.0.1:2080
npm config set https-proxy http://127.0.0.1:2080
# 安装
npm install -g @anthropic-ai/claude-code

# 验证是否安装成功：
claude-code --version # 2.0.76 (Claude Code)
claude-code --help
```

设置 ANTHROPIC_API_KEY

需要设置 Anthropic API 密钥作为环境变量：

方法 A：临时设置（当前会话有效）

export ANTHROPIC_API_KEY="your-api-key-here"

方法 B：永久设置（添加到 shell 配置文件）

打开终端并确定使用的 shell：echo $SHELL

根据 shell 类型编辑相应的配置文件：
- 对于 bash：`~/.bash_profile` 或 `~/.bashrc`
- 对于 zsh：`~/.zshrc`


在配置文件末尾添加以下行：export ANTHROPIC_API_KEY="your-api-key-here"
重新加载配置文件：`source ~/.zshrc` # 或 `source ~/.bash_profile`

方法 C：使用配置文件
- 创建配置文件 `~/.anthropic/config.json`：

```json
{
  "api_key": "your-api-key-here"
}
```

2. 可选环境变量
- ANTHROPIC_API_BASE：自定义 API 端点（如果需要）
- CLAUDE_CODE_MODEL：指定默认使用的模型（如：claude-3-5-sonnet-20241022）


#### 国内使用

如何在国内合法、安全地使用上 Claude Code? 



```sh
npm install -g https://gaccode.com/claudecode/install --registry=https://registry.npmmirror.com
```

报错

```sh
npm error code UNABLE_TO_GET_ISSUER_CERT_LOCALLY
npm error errno UNABLE_TO_GET_ISSUER_CERT_LOCALLY
```

启动 claude，报错：
>  Failed to connect to api.anthropic.com: UNABLE_TO_GET_ISSUER_CERT_LOCALLY

【2025-12-29】实践有效，解法：
- 在 ~/.claude.json 中添加：

```json
"hasCompletedOnboarding": true,
```

#### 本地大模型服务

CC Switch 和 [Cherry Studio](https://cherry-ai.com/)
- CC Switch [下载地址](https://github.com/farion1231/cc-switch/releases)

```sh
# 1. 添加 tap
brew tap farion1231/ccswitch
# 2. 安装应用
brew install --cask cc-switch
```

Cherry Studio
- 下载 [download](https://www.cherry-ai.com/download)


### 使用命令

基本使用命令

```sh
# 1. 初始化配置
claude-code init
# 2. 交互式对话
claude-code chat
# 3. 代码分析
claude-code analyze [文件或目录路径]
# 4. 文件操作
# 读取文件
claude-code read [文件路径]
# 编辑文件
claude-code edit [文件路径]
# 5. 项目分析
# 分析整个项目
claude-code project [项目目录]
# 搜索代码
claude-code search "搜索模式" [目录]
# 6. 获取帮助
# 查看所有命令
claude-code --help
# 查看特定命令帮助
claude-code [命令] --help
```


### 原理

框架 
1. 收集上下文——理解错误指向什么、代码库的哪部分受影响、哪些文件相关。
2. 制定计划——决定如何解决问题，比如修改代码并运行测试验证修复。
3. 执行操作——实际实施方案，通过更新文件和运行命令。

关键点: 第一步和最后一步都要求助手与外部世界交互——读取文件、获取文档、运行命令或编辑代码

![](https://priv-sdn-001.mowen.cn/mo/file/meta/14/90/31/2004186061168033793.png)

Claude 系列模型（Opus、Sonnet、Haiku）在理解工具作用并高效使用工具来完成复杂任务方面尤其强。

强工具使用的好处
- 解决更难的任务——Claude 能组合不同工具处理复杂工作，并能使用它未见过的工具。
- 可扩展的平台——你可以轻松为 Claude Code 添加新工具，Claude 会随你的工作流演进而适应使用。
- 更好的安全性——Claude Code 能在无需索引的情况下导航代码库，通常意味着不必把整个代码库发送到外部服务器。


### 使用

【2025-12-25】[Claude Code 实战](https://note.mowen.cn/detail/1_ZEnLT5BCYVsix54iB77)
- 官方 [Claude-code-in-action](https://anthropic.skilljar.com/claude-code-in-action)

- 第一部分介绍什么是Claude Code;
  - 用 Claude Code 执行软件开发任务，涵盖 AI 编码助手的底层架构、实用落地技巧，以及高级集成策略
- 第二部分主要介绍了如何上手去操作；
- 第三部分介绍了进阶操作：Hooks And SDK。

#### 什么是 Claude Code

内容
1. 理解编码助手架构：了解 AI 助手如何通过工具集成与代码库交互，以及支撑代码分析与修改的技术基础。
2. 探索 Claude Code 的工具系统：学习如何组合使用多种工具，处理各类开发场景中的复杂、多步骤编程任务。
3. 掌握上下文管理技巧：学习在对话中保持相关上下文，并有效引用项目资源以获得最佳 AI 协助。
4. 实现可视化沟通工作流：理解如何使用视觉输入沟通界面改动，并在复杂代码库修改中利用高级规划功能。
5. 创建自定义自动化：探索如何构建可复用的自定义命令与自动化，简化重复性开发任务。
6. 用 MCP 服务器扩展能力：学习集成外部工具与服务，实现如浏览器自动化与专用开发工作流等增强能力。
7. 集成 GitHub 工作流：理解如何搭建自动化代码审查流程，将 AI 协助融入现有版本控制工作流。
8. 应用思考与规划模式：学习在不同复杂度的编程挑战中何时、如何使用不同的推理方式。

### 高级功能

【2025-12-5】[Claude Code 发布的一些高级功能](https://mp.weixin.qq.com/s/Vpkzra5I8lvyTA8jX8l_2A)

1. 思考模式 (Thinking Mode)
2. 计划模式 (Plan Mode)
3. 自定义斜杠命令
4. 钩子系统 (Hooks)
5. 自定义代理 (Agents)
6. 插件系统 (Plugins)
7. MCP 服务器
8. 对话管理
9. 后台命令与沙盒模式
10. 权限管理
11. Explore 子代理
12. 最佳实践总结

#### 思考模式

| 关键词       | 深度   | 适用场景               |
|--------------|--------|------------------------|
| think        | 标准   | 一般复杂问题           |
| think harder | 深度   | 架构设计、复杂算法     |
| ultrathink   | 极深   | 系统级设计、疑难问题   |

实践
1. 复杂问题才用深度思考：简单任务用 ultrathink 是浪费
2. 结合具体问题描述：think about X 比单独 think 效果更好
3. 观察思考过程：通过思考输出理解 Claude 的推理逻辑

#### 计划模式

计划模式将任务分为"计划"和"执行"两个阶段，Claude 先制定详细计划，获得你的批准后再执行。适合大型重构、新功能开发等场景。


#### 自定义斜杠

在 .claude/commands/ 目录创建 Markdown 文件，自动成为可用的斜杠命令，方便复用常用提示词。


#### 钩子系统 (Hooks)

钩子允许在 Claude Code 特定事件发生时自动执行 shell 命令，实现自动化工作流。

#### 自定义代理 (Agents)

自定义代理是具有专门能力和工具限制的 Claude 实例，适合将复杂任务委托给专门的"专家"。

#### 插件系统 (Plugins)

插件系统允许从市场安装或自己创建扩展，包括命令、代理、钩子和 MCP 服务器。


#### MCP 服务器

MCP (Model Context Protocol) 允许 Claude 连接外部服务，如数据库、API、文件系统等，扩展其能力边界。

#### 对话管理

Claude Code 提供完整的对话管理功能，支持恢复、回退、导出和搜索历史对话。

#### 后台命令与沙盒模式

- 后台命令 (Ctrl+B)：将长时间运行的命令放到后台执行，Claude 可以继续其他工作。
- 沙盒模式：限制 Bash 工具的系统访问权限，防止意外的破坏性操作。

#### 权限管理

精细控制 Claude 可以使用的工具和操作，平衡效率与安全。

#### Explore 子代理

Explore 是专门用于代码库探索的子代理，由 Haiku 驱动，高效且节省上下文。

### Claude Code 复现


#### OpenCode

【2025-11-4】[终端里的 AI 编程助手：OpenCode 使用指南](https://developer.aliyun.com/article/1687474)

OpenCode 是一个开源 AI 编码工具，专为终端环境设计。装好后在命令行里直接和 AI 对话，让它帮你写代码、找 Bug、做重构。

主要特点：
- 原生终端界面，响应快，支持自定义主题
- 支持 Claude、GPT-4、Gemini 等多个 AI 模型
- 自动扫描项目文件，理解代码结构
- MIT 开源协议，GitHub 获 3 万+ 星标

OpenCode 有几个设计亮点：
- Client/Server 分离，支持远程控制
- SQLite 管理会话，持久化对话历史
- 插件化设计，方便扩展功能
- 统一接口适配多个 AI 提供商

使用注意事项
- 需要支持 TUI 的现代终端，推荐 WezTerm、Alacritty、Kitty
- 使用第三方 AI 模型需付费，Claude Pro 订阅相对划算
- AI 生成代码建议审查后再提交，特别是安全相关部分


两种工作模式
- Plan 模式（规划）：只分析不修改，适合代码审查、性能分析：
  - 示例：/plan 分析项目的性能瓶颈
- Build 模式（构建）：实际修改代码，适合重构、添加功能：
  - 示例：/build 把 API 请求改用 axios 拦截器统一处理


安装

```sh
# 配置代理
export http_proxy=127.0.0.1:2080
export https_proxy=127.0.0.1:2080
# 安装opencode
curl -fsSL https://opencode.ai/install | bash # bash
npm install -g opencode-ai # npm 安装
brew install sst/tap/opencode # Homebrew 安装（macOS/Linux）
```

配置模型

运行配置命令
- 按提示选择 AI 提供商（Anthropic、OpenAI、Google 等），输入对应的 API Key。
- 推荐使用 Claude 3.5 Sonnet，代码能力较强。

```sh
opencode auth login
```


常用功能

- 切换模型：/models ， 在不同 AI 模型间切换，比如用 Claude 写代码，用 GPT-4 做审查。
- 撤销修改：/undo，AI 改错了可以一键回滚。
- 分享会话：/share，生成公开链接，把对话记录分享给同事。
- 更换主题：/themes 或按 Ctrl+X 再按 T 切换终端主题。


初始化项目

进入项目目录：

```sh
cd your-project
opencode
```

在界面中输入初始化命令：

```sh
/init
```

OpenCode 会扫描项目，生成 AGENTS.md 文件记录项目信息，后续对话基于这个上下文进行。

使用方法
- 理解代码：这个 useAuth.ts 文件的作用是什么
- 修复问题：修复 api/users.ts 的类型错误
- 添加功能：给 Express 项目加用户注册接口，需要邮箱验证和密码加密


## Skills

【2025-12-16】[Claude Skills成为复杂工作流的最优解](https://www.toutiao.com/article/7584271980476596736)

[Agent Skill笔记](https://my.feishu.cn/wiki/HKtrwm5w9ikmNxkuCabc1juPnnc?from=from_copylink)



### Agent 为何需要“技能”？

通用大模型在执行专业任务时面临三大挑战：
- a， 上下文窗口限制： 无法将海量的专业知识（如公司内部的开发规范、品牌设计指南）一次性灌输给模型。
- b， 流程不确定性： 即使通过提示词进行指导，AI 在执行多步骤、复杂任务时，其输出结果和行为也常常不稳定、不一致。
- c， 高昂的 Token 成本： 每次请求都附带大量重复的背景信息和指令，导致成本高昂且效率低下。

Agent Skills 通过“程序化知识封装”解决了这些问题。 不是简单的提示词，而更像是一份标准作业程序（SOP）或一本给 AI 的“岗前培训手册”。


### 上下文工程问题

两个核心工程挑战，直接决定了agent的“天花板”：
1. 上下文窗口的稀缺性： 如何让模型“知道”数百个工具的定义，而不耗尽昂贵且有限的上下文？
2. 编排逻辑的复杂性： 面对多步骤、长周期的任务，如何保证模型遵循既定的业务流程，确保任务的鲁棒性？

核心矛盾：Context Window的有限性 vs 能力需求的无限性

传统做法是把所有工具、所有指令都塞进system prompt：
> System Prompt = 基础指令 + 所有工具描述 + 所有专业知识 = 50K+ tokens = 高延迟 + 高成本 + 低效率

传统 API 函数调用 因其“急切加载”机制和对客户端的编排负担，已步履维艰。

解决**连接性碎片化** 确立了“通用连接器”的生态地位。

### Skills 介绍

然而，真正的架构质变来自 Anthropic 最新 Claude Skills 。

Claude Code Skills设计灵感来自类比：
> 人类专家不是把所有知识都装在脑子里，而是在需要时查阅手册、调用专业知识。

Skills系统让AI Agent也具备这种能力：
> 用户请求 → Agent识别需要PDF技能 → 动态加载PDF处理指令 → 执行专业任务 → 返回结果

Claude Skills 不再将功能视为简单的工具集合，而是将其封装为“**程序性知识**”
- 一份专业的“员工入职手册”。

Skills + MCP 分层架构是构建下一代企业级高能效智能代理的最佳路径。

API 函数调用是不可或缺的底层执行原语，但其“急切加载”的上下文机制和脆弱的编排逻辑，使其不适合作为构建复杂、可扩展代理应用的核心架构 。模型上下文协议 成功地解决了连接性难题，为 AI 提供了标准化的“管道” 。

而 Claude Skills 代表了架构的质变。它通过渐进式披露”机制解决了上下文的扩展性瓶颈，无论是拥有 10 个还是 1000 个技能，启动成本都极低。更关键的是，它将复杂流程显式定义在 中，结合沙盒代码执行，极大地提升了复杂任务的流程鲁棒性和标准化。

三种设计范式：API Function Calling → MCP → Claude Skills

### Agent Skill

Agent Skill 本质上是结构化文件夹。

最简结构仅包含一个核心文件：`SKILL.md`。

```md
your-skill-name/
└── SKILL .md
```

这个 SKILL.md 文件通过 YAML frontmatter 定义元数据，通过 Markdown 正文提供详细指令。
- 元数据 (Metadata): 告诉 Agent 这个 Skill 的“身份”和“用途”。
  - name: 技能的唯一标识，必须与文件夹名一致。
  - description: 功能描述，是 Agent 决定是否激活此技能的关键依据。
- 指令 (Instructions): 告诉 Agent 在激活此技能后，应该“如何做”。这是分步的工作流指南。

关键机制：渐进式信息披露 (Progressive Disclosure)

Agent Skills 的设计精髓在于其高效的 Token 利用机制，它分三层按需加载信息：
- 第一层：元数据 (Metadata)Agent 启动时，仅加载所有可用 Skills 的 name 和 description。这消耗的 Token 极少，但足以让 Agent 对其能力库有一个全局认知。
- 第二层：核心指令 (Core Instructions)当用户的请求与某个 Skill 的 description 匹配时，Agent 才会完整加载该 Skill 的 SKILL .md 文件内容，获取详细的操作指南。
- 第三层：支持资源 (Supporting Resources)如果 SKILL .md 的指令中引用了外部脚本（位于 scripts/ 目录）或参考文档（位于 references/ 目录），Agent 仅在执行到该步骤时才会去访问这些文件。特别地，当执行脚本时，只有脚本的输出结果会进入上下文，代码本身不会，极大地节省了成本并保证了执行的确定性。

这种分层机制确保了 Agent 在具备强大扩展性的同时，运行成本极低且响应迅速。

### Skills 结构

SKILL.md文件的目录：

```md
.minion/skills/
├── pdf/
│   ├── SKILL.md          # 技能定义和指令
│   ├── references/       # 参考资料
│   ├── scripts/          # 辅助脚本
│   └── assets/           # 资源文件
├── xlsx/
│   └── SKILL.md
└── docx/
    └── SKILL.md
```

SKILL.md 采用YAML frontmatter + Markdown body的格式


### 实现

#### Minion Skills

【2025-12-22】[Minion Skills：Claude Skills的开源实现](https://zhuanlan.zhihu.com/p/1986411204265153141)

#### LangChain Skills

LangChain [Skills](https://docs.langchain.com/oss/python/langchain/multi-agent/skills) 支持

```py
from langchain.tools import tool
from langchain.agents import create_agent

@tool
def load_skill(skill_name: str) -> str:
    """Load a specialized skill prompt.

    Available skills:
    - write_sql: SQL query writing expert
    - review_legal_doc: Legal document reviewer

    Returns the skill's prompt and context.
    """
    # Load skill content from file/database
    ...

agent = create_agent(
    model="gpt-4o",
    tools=[load_skill],
    system_prompt=(
        "You are a helpful assistant. "
        "You have access to two skills: "
        "write_sql and review_legal_doc. "
        "Use load_skill to access them."
    ),
)
```


# 结束
